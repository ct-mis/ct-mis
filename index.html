<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å°ç£ç’°å³¶å¤§å¯Œç¿ - å¤ªé­¯é–£å¯¦æ™¯ç‰ˆ</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --board-bg: #e3f2fd;
            --tile-bg: #ffffff;
            --tile-border: #546e7a;
            --p1-color: #d32f2f; /* ç´…è‰²è»Šå­ */
            --p2-color: #2e7d32; /* ç¶ è‰²æ©Ÿå™¨äºº */
            --p1-bg: #ffcdd2;    /* ç©å®¶1é ˜åœ°èƒŒæ™¯ */
            --p2-bg: #c8e6c9;    /* ç©å®¶2é ˜åœ°èƒŒæ™¯ */
            --dice-size: 50px;
            --chance-bg: #e1bee7;
            --destiny-bg: #ffccbc;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: "Noto Sans TC", "Microsoft JhengHei", sans-serif;
            background-color: #263238;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden;
        }

        /* ------ å¤ªé­¯é–£ç‰‡é ­å‹•ç•« ------ */
        #intro-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #000;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: opacity 1s ease-out;
            color: white;
            text-align: center;
            overflow: hidden;
        }

        /* å¯¦æ™¯èƒŒæ™¯åœ– */
        .taroko-bg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            /* ä½¿ç”¨ Unsplash çš„å¤ªé­¯é–£/å³½è°·é¢¨æ ¼åœ–ç‰‡ */
            background-image: url('https://images.unsplash.com/photo-1552993873-0dd1110e025f?q=80&w=1920&auto=format&fit=crop');
            background-size: cover;
            background-position: center;
            z-index: -2;
            animation: slowZoom 20s infinite alternate;
        }

        /* é›²éœ§æ•ˆæœ */
        .cloud {
            position: absolute;
            background: rgba(255, 255, 255, 0.4);
            border-radius: 50%;
            filter: blur(30px);
            animation: floatCloud 25s linear infinite;
        }

        @keyframes slowZoom {
            0% { transform: scale(1); }
            100% { transform: scale(1.1); }
        }

        @keyframes floatCloud {
            0% { transform: translateX(-100vw); opacity: 0; }
            10% { opacity: 0.6; }
            90% { opacity: 0.6; }
            100% { transform: translateX(100vw); opacity: 0; }
        }

        #intro-content {
            z-index: 10;
            background: rgba(0, 0, 0, 0.6);
            padding: 40px;
            border-radius: 20px;
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255,255,255,0.3);
            box-shadow: 0 20px 50px rgba(0,0,0,0.8);
            animation: zoomIn 1.5s ease-out;
        }

        .intro-title {
            font-size: 8vmin;
            font-weight: bold;
            margin-bottom: 10px;
            text-shadow: 0 4px 10px rgba(0,0,0,1);
            letter-spacing: 5px;
            color: #fff;
        }
        
        .intro-subtitle {
            font-size: 4vmin;
            margin-bottom: 30px;
            font-weight: 300;
            color: #e0e0e0;
        }

        #start-btn {
            padding: 15px 60px;
            font-size: 5vmin;
            background: linear-gradient(45deg, #d84315, #ff5722);
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(216, 67, 21, 0.5);
            font-weight: bold;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        #start-btn:hover { transform: scale(1.05); box-shadow: 0 8px 25px rgba(216, 67, 21, 0.7); }
        #start-btn:active { transform: scale(0.95); }

        .fade-out { opacity: 0 !important; pointer-events: none; }

        @keyframes zoomIn {
            0% { transform: scale(0.8); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        /* ------ éŠæˆ²ä¸»ç•«é¢ ------ */
        #game-container {
            width: 98vmin;
            height: 98vmin;
            background-color: var(--board-bg);
            border-radius: 12px;
            position: relative;
            box-shadow: 0 10px 30px rgba(0,0,0,0.8);
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            grid-template-rows: repeat(8, 1fr);
            gap: 2px;
            padding: 4px;
            opacity: 0;
            transition: opacity 1s;
        }

        .tile {
            background-color: var(--tile-bg);
            border: 1px solid var(--tile-border);
            border-radius: 4px;
            font-size: 1.8vmin;
            font-weight: bold;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            text-align: center;
            position: relative;
            color: #333;
            overflow: hidden;
            padding-top: 3px;
            transition: background-color 0.3s;
        }

        .tile-name { z-index: 2; margin-bottom: 2px; font-weight: 800; }
        .tile-price { font-size: 1.4vmin; color: #555; font-weight: normal; z-index: 2; }
        
        .house-container {
            display: flex;
            gap: 1px;
            margin-top: 1px;
            z-index: 2;
            height: 1.4vmin;
            justify-content: center;
            width: 100%;
        }
        .house-icon { color: #f57c00; font-size: 1.4vmin; }

        /* è§’è½ */
        .tile:nth-child(1), .tile:nth-child(8), .tile:nth-child(15), .tile:nth-child(22) {
            background-color: #fff3e0;
        }
        .tile.is-chance { background-color: var(--chance-bg); color: #4a148c; justify-content: center; padding-top: 0;}
        .tile.is-destiny { background-color: var(--destiny-bg); color: #bf360c; justify-content: center; padding-top: 0;}

        .tile.owned-p1 { background-color: var(--p1-bg); border: 2px solid var(--p1-color); }
        .tile.owned-p2 { background-color: var(--p2-bg); border: 2px solid var(--p2-color); }

        .player-token {
            font-size: 3.5vmin;
            position: absolute;
            transition: all 0.3s cubic-bezier(0.25, 0.1, 0.25, 1);
            z-index: 10;
            filter: drop-shadow(2px 2px 2px rgba(0,0,0,0.5));
        }

        .player-1 { color: var(--p1-color); top: 55%; left: 10%; }
        .player-2 { color: var(--p2-color); top: 55%; right: 10%; }

        /* ç•¶å…©äººåœ¨åŒä¸€æ ¼æ™‚éŒ¯é–‹ */
        .tile.has-p1.has-p2 .player-1 { transform: translate(-8px, -5px); }
        .tile.has-p1.has-p2 .player-2 { transform: translate(8px, 5px); }

        /* ä¸­å¤®å€åŸŸ */
        #center-area {
            grid-column: 2 / 8;
            grid-row: 2 / 8;
            background: linear-gradient(135deg, rgba(255,255,255,0.9) 0%, rgba(255,255,255,0.95) 100%);
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            z-index: 5;
            position: relative;
            padding: 10px;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.05);
        }

        /* ç©å®¶è¨ˆåˆ†æ¿ */
        .score-board {
            display: flex;
            width: 100%;
            justify-content: space-around;
            margin-bottom: 5px;
        }
        
        .player-card {
            background: #fff;
            padding: 8px 15px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            text-align: center;
            width: 45%;
            border: 2px solid transparent;
            position: relative;
            transition: transform 0.2s;
        }

        .player-card.active { border-color: #ff9800; background-color: #fff8e1; transform: scale(1.05); }

        .skip-badge {
            position: absolute;
            top: -8px; right: -8px;
            background-color: #d32f2f; color: white;
            border-radius: 50%; width: 24px; height: 24px;
            font-size: 14px; display: flex; justify-content: center; align-items: center;
            display: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .p-name { font-weight: bold; font-size: 3vmin; margin-bottom: 4px; }
        .p-money { font-size: 3.5vmin; font-family: "Courier New", monospace; color: #333; font-weight: bold; }
        .p1-style { color: var(--p1-color); }
        .p2-style { color: var(--p2-color); }

        /* æ§åˆ¶å€ */
        .game-controls {
            display: flex; flex-direction: column; align-items: center; justify-content: center; flex-grow: 1; width: 100%;
        }

        #status-text {
            font-size: 3.5vmin; margin-bottom: 15px; font-weight: bold; color: #37474f;
            text-align: center; min-height: 2.4em; white-space: pre-line; width: 90%; line-height: 1.3;
        }

        #roll-btn {
            padding: 12px 50px; font-size: 4vmin; background: linear-gradient(to bottom, #ffa726, #fb8c00); color: white;
            border: none; border-radius: 50px; cursor: pointer; box-shadow: 0 4px #e65100;
            transition: all 0.1s; font-weight: bold; text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }

        #roll-btn:active { transform: translateY(4px); box-shadow: 0 0 #e65100; }
        #roll-btn:disabled { background: #cfd8dc; color: #90a4ae; box-shadow: none; cursor: not-allowed; }

        /* ------ 3D éª°å­æ¨£å¼ ------ */
        .dice-container {
            width: var(--dice-size); height: var(--dice-size);
            perspective: 800px; margin-bottom: 25px; display: none;
        }
        .dice { width: 100%; height: 100%; position: relative; transform-style: preserve-3d; }
        .face {
            position: absolute; width: 100%; height: 100%; background: #fff;
            border: 1px solid #ccc; border-radius: 8px;
            display: flex; justify-content: center; align-items: center; font-size: 0;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.15);
        }
        .dot {
            display: block; width: 10px; height: 10px; border-radius: 50%;
            background-color: #222; position: absolute;
            box-shadow: inset 1px 1px 2px rgba(0,0,0,0.5);
        }
        /* ç´…è‰²é»æ•¸: 1 å’Œ 4 */
        .face[data-face="1"] .dot, .face[data-face="4"] .dot { background-color: #d32f2f; }
        
        /* Transforms for faces */
        .face[data-face="1"] { transform: rotateY(0deg) translateZ(25px); }
        .face[data-face="2"] { transform: rotateY(180deg) translateZ(25px); }
        .face[data-face="3"] { transform: rotateY(90deg) translateZ(25px); }
        .face[data-face="4"] { transform: rotateY(-90deg) translateZ(25px); }
        .face[data-face="5"] { transform: rotateX(90deg) translateZ(25px); }
        .face[data-face="6"] { transform: rotateX(-90deg) translateZ(25px); }

        /* Dot Layout */
        .face[data-face="1"] .dot:nth-child(1) { width: 18px; height: 18px; } /* Big red dot */
        .face[data-face="2"] .dot:nth-child(1) { top: 20%; left: 20%; }
        .face[data-face="2"] .dot:nth-child(2) { bottom: 20%; right: 20%; }
        .face[data-face="3"] .dot:nth-child(1) { top: 20%; left: 20%; }
        .face[data-face="3"] .dot:nth-child(2) { top: 50%; left: 50%; transform: translate(-50%, -50%); }
        .face[data-face="3"] .dot:nth-child(3) { bottom: 20%; right: 20%; }
        .face[data-face="4"] .dot:nth-child(1) { top: 20%; left: 20%; }
        .face[data-face="4"] .dot:nth-child(2) { top: 20%; right: 20%; }
        .face[data-face="4"] .dot:nth-child(3) { bottom: 20%; left: 20%; }
        .face[data-face="4"] .dot:nth-child(4) { bottom: 20%; right: 20%; }
        .face[data-face="5"] .dot:nth-child(1) { top: 20%; left: 20%; }
        .face[data-face="5"] .dot:nth-child(2) { top: 20%; right: 20%; }
        .face[data-face="5"] .dot:nth-child(3) { top: 50%; left: 50%; transform: translate(-50%, -50%); }
        .face[data-face="5"] .dot:nth-child(4) { bottom: 20%; left: 20%; }
        .face[data-face="5"] .dot:nth-child(5) { bottom: 20%; right: 20%; }
        .face[data-face="6"] .dot:nth-child(1) { top: 15%; left: 20%; }
        .face[data-face="6"] .dot:nth-child(2) { top: 15%; right: 20%; }
        .face[data-face="6"] .dot:nth-child(3) { top: 50%; left: 20%; transform: translateY(-50%); }
        .face[data-face="6"] .dot:nth-child(4) { top: 50%; right: 20%; transform: translateY(-50%); }
        .face[data-face="6"] .dot:nth-child(5) { bottom: 15%; left: 20%; }
        .face[data-face="6"] .dot:nth-child(6) { bottom: 15%; right: 20%; }

        /* Overlay */
        #overlay-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 100;
            display: flex; justify-content: center; align-items: center;
            visibility: hidden; opacity: 0; transition: opacity 0.3s;
            backdrop-filter: blur(2px);
        }
        #overlay-layer.active { visibility: visible; opacity: 1; }

        /* ç¿»ç‰Œå‹•ç•« */
        .card-container { width: 60vmin; height: 75vmin; perspective: 1000px; display: none; }
        .card-container.active-mode { display: block; }
        .card-inner {
            position: relative; width: 100%; height: 100%; text-align: center;
            transition: transform 0.8s; transform-style: preserve-3d;
        }
        .card-container.flipped .card-inner { transform: rotateY(180deg); }
        .card-front, .card-back {
            position: absolute; width: 100%; height: 100%; backface-visibility: hidden;
            border-radius: 15px; display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            box-shadow: 0 10px 20px rgba(0,0,0,0.4); border: 8px solid white;
        }
        .card-front { background-color: #333; color: white; transform: rotateY(0deg); cursor: pointer; }
        .card-front.chance-bg { background: linear-gradient(135deg, #7b1fa2, #4a148c); }
        .card-front.destiny-bg { background: linear-gradient(135deg, #e64a19, #bf360c); }
        .card-front i { font-size: 15vmin; margin-bottom: 20px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3)); }
        .card-front h2 { font-size: 8vmin; text-transform: uppercase; letter-spacing: 2px; }
        .card-back {
            background-color: white; color: #333; transform: rotateY(180deg);
            padding: 20px; justify-content: space-between;
        }
        .card-back h3 { font-size: 6vmin; margin-bottom: 10px; font-weight: bold; border-bottom: 2px solid #eee; width: 100%; padding-bottom: 10px; }
        .card-description { font-size: 5vmin; font-weight: bold; margin-bottom: 20px; white-space: pre-line; color: #444; }
        .card-icon-lg { font-size: 12vmin; margin: 20px 0; color: #607d8b; }
        .modal-btn {
            padding: 12px 40px; font-size: 4vmin; background-color: #1976d2; color: white;
            border: none; border-radius: 30px; cursor: pointer; margin: 10px;
            box-shadow: 0 4px #0d47a1; transition: transform 0.1s;
        }
        .modal-btn:active { transform: translateY(4px); box-shadow: none; }

        /* å°è©±æ¡† */
        .modal-box {
            background: white; width: 85vmin; padding: 25px; border-radius: 15px;
            text-align: center; display: none; box-shadow: 0 15px 30px rgba(0,0,0,0.5);
            animation: popIn 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28);
        }
        .modal-box.active-mode { display: block; }
        .modal-title { font-size: 5.5vmin; font-weight: bold; margin-bottom: 15px; color: #333; }
        .modal-text { font-size: 4vmin; margin-bottom: 25px; color: #555; line-height: 1.6; }
        .btn-group { display: flex; justify-content: center; gap: 20px; }
        .btn-yes { background-color: #4caf50; box-shadow: 0 4px #2e7d32; }
        .btn-no { background-color: #f44336; box-shadow: 0 4px #c62828; }

        @keyframes popIn {
            0% { transform: scale(0.8); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

    </style>
</head>
<body>

<!-- èƒŒæ™¯éŸ³æ¨‚ -->
<audio id="bgm" loop>
    <source src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3" type="audio/mp3">
</audio>

<!-- å¤ªé­¯é–£å¯¦æ™¯ç‰‡é ­ -->
<div id="intro-screen">
    <div class="taroko-bg"></div>
    <!-- é›²éœ§ -->
    <div class="cloud" style="top: 10%; width: 200px; height: 100px; left: -20%;"></div>
    <div class="cloud" style="top: 30%; width: 300px; height: 120px; left: -10%; animation-duration: 30s;"></div>
    <div class="cloud" style="top: 20%; width: 250px; height: 100px; right: -20%; animation-direction: reverse;"></div>
    
    <div id="intro-content">
        <div class="intro-title">å°ç£ç’°å³¶å¤§å¯Œç¿</div>
        <div class="intro-subtitle">å¤ªé­¯é–£é¢¨æƒ…ç‰ˆ</div>
        <button id="start-btn" onclick="startGame()">é–‹å§‹æ—…ç¨‹</button>
    </div>
</div>

<!-- éŠæˆ²ä¸»é«” -->
<div id="game-container">
    <div id="center-area">
        <div class="score-board">
            <div class="player-card active" id="p1-card">
                <div class="p-name p1-style"><i class="fas fa-car-side"></i> ç©å®¶ 1</div>
                <div class="p-money">$<span id="p1-money">10000</span></div>
                <div class="skip-badge" id="p1-skip"><i class="fas fa-ban"></i></div>
            </div>
            <div class="player-card" id="p2-card">
                <div class="p-name p2-style"><i class="fas fa-robot"></i> ç©å®¶ 2</div>
                <div class="p-money">$<span id="p2-money">10000</span></div>
                <div class="skip-badge" id="p2-skip"><i class="fas fa-ban"></i></div>
            </div>
        </div>

        <div class="game-controls">
            <div class="dice-container" id="dice-wrapper">
                <div class="dice" id="dice">
                    <div class="face" data-face="1"><span class="dot"></span></div>
                    <div class="face" data-face="2"><span class="dot"></span><span class="dot"></span></div>
                    <div class="face" data-face="3"><span class="dot"></span><span class="dot"></span><span class="dot"></span></div>
                    <div class="face" data-face="4"><span class="dot"></span><span class="dot"></span><span class="dot"></span><span class="dot"></span></div>
                    <div class="face" data-face="5"><span class="dot"></span><span class="dot"></span><span class="dot"></span><span class="dot"></span><span class="dot"></span></div>
                    <div class="face" data-face="6"><span class="dot"></span><span class="dot"></span><span class="dot"></span><span class="dot"></span><span class="dot"></span><span class="dot"></span></div>
                </div>
            </div>
            <div id="status-text">æº–å‚™å¥½ç’°å³¶äº†å—ï¼Ÿ</div>
            <button id="roll-btn" onclick="game.turn()" disabled>æ“²éª°å­</button>
        </div>
    </div>
</div>

<!-- å½ˆå‡ºå±¤ (æ©Ÿæœƒ/å‘½é‹/å°è©±æ¡†) -->
<div id="overlay-layer">
    <!-- å¡ç‰‡ -->
    <div class="card-container" id="card-scene">
        <div class="card-inner" id="card-inner">
            <div class="card-front" id="card-front-face">
                <i class="fas fa-question"></i>
                <h2>æ©Ÿæœƒ</h2>
            </div>
            <div class="card-back">
                <div style="flex-grow:1; display:flex; flex-direction:column; justify-content:center; align-items:center;">
                    <h3 id="card-title">æ©Ÿæœƒå¡</h3>
                    <div id="card-icon-area" class="card-icon-lg"></div>
                    <div class="card-description" id="card-desc">å…§å®¹</div>
                </div>
                <button class="modal-btn" onclick="game.closeCard()">ç¢ºå®š</button>
            </div>
        </div>
    </div>

    <!-- è©¢å•è¦–çª— -->
    <div class="modal-box" id="modal-box">
        <div class="modal-title" id="modal-title">æ¨™é¡Œ</div>
        <div class="modal-text" id="modal-text">å…§å®¹</div>
        <div class="btn-group">
            <button class="modal-btn btn-yes" id="modal-yes">æ˜¯</button>
            <button class="modal-btn btn-no" id="modal-no">å¦</button>
        </div>
    </div>
</div>

<script>
    // --- éŠæˆ²åˆå§‹åŒ– ---
    function startGame() {
        const bgm = document.getElementById('bgm');
        bgm.volume = 0.3;
        bgm.play().catch(e => console.log("Auto-play prevented by browser policy", e));

        const screen = document.getElementById('intro-screen');
        const gameContainer = document.getElementById('game-container');
        
        // æ·¡å‡ºå‹•ç•«
        screen.style.opacity = '0';
        setTimeout(() => {
            screen.classList.add('fade-out');
            gameContainer.style.opacity = '1';
            document.getElementById('status-text').innerText = "éŠæˆ²é–‹å§‹ï¼\nè¼ªåˆ° ç©å®¶ 1 (è»Šå­)";
            document.getElementById('roll-btn').disabled = false;
        }, 1000);
    }

    // åœ°åœ–è³‡æ–™ (24åœ°å + 4åŠŸèƒ½æ ¼ = 28æ ¼)
    const mapData = [
        { name: "å°åŒ—", type: 'prop', price: 4000, rent: 400, owner: null, level: 0 },
        { name: "åŸºéš†", type: 'prop', price: 2000, rent: 200, owner: null, level: 0 },
        { name: "æ–°åŒ—", type: 'prop', price: 3000, rent: 300, owner: null, level: 0 },
        { name: "æ¡ƒåœ’", type: 'prop', price: 2500, rent: 250, owner: null, level: 0 },
        { name: "æ©Ÿæœƒ", type: 'chance' },
        { name: "æ–°ç«¹", type: 'prop', price: 2500, rent: 250, owner: null, level: 0 },
        { name: "è‹—æ —", type: 'prop', price: 2000, rent: 200, owner: null, level: 0 },
        { name: "å°ä¸­", type: 'prop', price: 3500, rent: 350, owner: null, level: 0 },
        { name: "å½°åŒ–", type: 'prop', price: 2200, rent: 220, owner: null, level: 0 },
        { name: "å—æŠ•", type: 'prop', price: 2000, rent: 200, owner: null, level: 0 },
        { name: "é›²æ—", type: 'prop', price: 1800, rent: 180, owner: null, level: 0 },
        { name: "å‘½é‹", type: 'destiny' },
        { name: "å˜‰ç¾©", type: 'prop', price: 2200, rent: 220, owner: null, level: 0 },
        { name: "å°å—", type: 'prop', price: 3000, rent: 300, owner: null, level: 0 },
        { name: "é«˜é›„", type: 'prop', price: 3800, rent: 380, owner: null, level: 0 },
        { name: "å±æ±", type: 'prop', price: 2400, rent: 240, owner: null, level: 0 },
        { name: "å¢¾ä¸", type: 'prop', price: 3000, rent: 300, owner: null, level: 0 },
        { name: "å°æ±", type: 'prop', price: 2200, rent: 220, owner: null, level: 0 },
        { name: "æ©Ÿæœƒ", type: 'chance' },
        { name: "èŠ±è“®", type: 'prop', price: 2600, rent: 260, owner: null, level: 0 },
        { name: "å¤ªé­¯é–£", type: 'prop', price: 2800, rent: 280, owner: null, level: 0 },
        { name: "å®œè˜­", type: 'prop', price: 2400, rent: 240, owner: null, level: 0 },
        { name: "ç¾…æ±", type: 'prop', price: 2000, rent: 200, owner: null, level: 0 },
        { name: "è˜‡æ¾³", type: 'prop', price: 1800, rent: 180, owner: null, level: 0 },
        { name: "é¦¬ç¥–", type: 'prop', price: 1500, rent: 150, owner: null, level: 0 },
        { name: "é‡‘é–€", type: 'prop', price: 1800, rent: 180, owner: null, level: 0 },
        { name: "å‘½é‹", type: 'destiny' },
        { name: "æ¾æ¹–", type: 'prop', price: 2500, rent: 250, owner: null, level: 0 }
    ];

    // 10ç¨®æ©Ÿæœƒ
    const chanceCards = [
        { type: 'money', val: 2000, text: "çµ±ä¸€ç™¼ç¥¨ä¸­çï¼\nç²å¾— $2,000", icon: "fa-receipt" },
        { type: 'money', val: 3000, text: "æŠ•è³‡ç²åˆ©ï¼\nç²å¾— $3,000", icon: "fa-chart-line" },
        { type: 'move', val: 3, text: "æ­ä¹˜é«˜éµï¼\nå‰é€² 3 æ­¥", icon: "fa-train" },
        { type: 'goto', target: 0, text: "ç›´æ¥è¿”å›å°åŒ—", icon: "fa-plane" },
        { type: 'move', val: 1, text: "å¤©æ°£æ™´æœ—ï¼Œå¤šèµ° 1 æ­¥", icon: "fa-walking" },
        { type: 'money', val: 1000, text: "æ’¿åˆ°éŒ¢ï¼\nç²å¾— $1,000", icon: "fa-coins" },
        { type: 'move', val: 2, text: "ç™¼ç¾æ·å¾‘ï¼\nå‰é€² 2 æ­¥", icon: "fa-route" },
        { type: 'money', val: 500, text: "ç²å¾—å°è²»\nç²å¾— $500", icon: "fa-smile-beam" },
        { type: 'money', val: 1500, text: "é€€ç¨…æ”¶å…¥\nç²å¾— $1,500", icon: "fa-hand-holding-usd" },
        { type: 'stop', val: 1, text: "å–æ¯çç å¥¶èŒ¶ä¼‘æ¯\næš«åœ 1 å›åˆ", icon: "fa-coffee" }
    ];

    // 10ç¨®å‘½é‹
    const destinyCards = [
        { type: 'money', val: -1000, text: "è¶…é€Ÿç½°å–®ï¼\næ”¯ä»˜ $1,000", icon: "fa-file-invoice" },
        { type: 'money', val: -2000, text: "è«‹æœ‹å‹åƒé£¯ï¼\næ”¯ä»˜ $2,000", icon: "fa-utensils" },
        { type: 'goto', target: 20, text: "çªç„¶æƒ³å»å¤ªé­¯é–£ç©\nç›´æ¥å‰å¾€å¤ªé­¯é–£", icon: "fa-mountain" },
        { type: 'money', val: -500, text: "éŒ¢åŒ…ç ´æ´ï¼\næå¤± $500", icon: "fa-wallet" },
        { type: 'move', val: -2, text: "å¿˜è¨˜å¸¶æ±è¥¿ï¼\nå¾Œé€€ 2 æ­¥", icon: "fa-undo" },
        { type: 'goto', target: 0, text: "è¢«å¼·åˆ¶é£è¿”å°åŒ—", icon: "fa-home" },
        { type: 'stop', val: 1, text: "è»Šå­æ‹‹éŒ¨\næš«åœ 1 å›åˆ", icon: "fa-car-crash" },
        { type: 'stop', val: 1, text: "é€£å‡å¡è»Šä¸­\næš«åœ 1 å›åˆ", icon: "fa-traffic-light" },
        { type: 'move', val: -3, text: "é‡åˆ°é¢±é¢¨ï¼\nå¾Œé€€ 3 æ­¥", icon: "fa-wind" },
        { type: 'money', val: -1500, text: "ç¹³ç´ä¿éšªè²»\næ”¯ä»˜ $1,500", icon: "fa-shield-alt" }
    ];

    const gridCoordinates = [
        {r:1, c:1}, {r:1, c:2}, {r:1, c:3}, {r:1, c:4}, {r:1, c:5}, {r:1, c:6}, {r:1, c:7}, {r:1, c:8},
        {r:2, c:8}, {r:3, c:8}, {r:4, c:8}, {r:5, c:8}, {r:6, c:8}, {r:7, c:8},
        {r:8, c:8}, {r:8, c:7}, {r:8, c:6}, {r:8, c:5}, {r:8, c:4}, {r:8, c:3}, {r:8, c:2}, {r:8, c:1},
        {r:7, c:1}, {r:6, c:1}, {r:5, c:1}, {r:4, c:1}, {r:3, c:1}, {r:2, c:1}
    ];

    class Game {
        constructor() {
            this.players = [
                { id: 1, pos: 0, money: 10000, skipTurn: 0, icon: '<i class="fas fa-car-side"></i>', name: "ç©å®¶ 1", colorClass: "player-1" },
                { id: 2, pos: 0, money: 10000, skipTurn: 0, icon: '<i class="fas fa-robot"></i>', name: "ç©å®¶ 2", colorClass: "player-2" }
            ];
            this.currentPlayerIndex = 0;
            this.isMoving = false;
            this.isGameOver = false;
            
            this.diceWrapper = document.getElementById('dice-wrapper');
            this.dice = document.getElementById('dice');
            this.statusText = document.getElementById('status-text');
            this.rollBtn = document.getElementById('roll-btn');
            
            // Modal elements
            this.overlay = document.getElementById('overlay-layer');
            this.cardContainer = document.getElementById('card-scene');
            this.modalBox = document.getElementById('modal-box');
            this.modalTitle = document.getElementById('modal-title');
            this.modalText = document.getElementById('modal-text');
            this.modalYes = document.getElementById('modal-yes');
            this.modalNo = document.getElementById('modal-no');

            this.cardFront = document.getElementById('card-front-face');
            this.cardFront.addEventListener('click', () => {
                if(!this.cardContainer.classList.contains('flipped')) this.cardContainer.classList.add('flipped');
            });

            this.initBoard();
            this.renderPlayers();
            this.updateInfoPanel();
        }

        initBoard() {
            const container = document.getElementById('game-container');
            mapData.forEach((data, index) => {
                const tile = document.createElement('div');
                tile.className = 'tile';
                tile.id = `tile-${index}`;
                
                const nameDiv = document.createElement('div');
                nameDiv.className = 'tile-name';
                nameDiv.innerText = data.name;
                tile.appendChild(nameDiv);

                if (data.type === 'prop') {
                    const priceDiv = document.createElement('div');
                    priceDiv.className = 'tile-price';
                    priceDiv.innerText = `$${data.price}`;
                    tile.appendChild(priceDiv);
                    
                    const houseContainer = document.createElement('div');
                    houseContainer.className = 'house-container';
                    houseContainer.id = `houses-${index}`;
                    tile.appendChild(houseContainer);
                } else if (data.type === 'chance') {
                    tile.classList.add("is-chance");
                    tile.innerHTML = '<i class="fas fa-question-circle" style="font-size:3vmin;margin-bottom:5px;"></i>æ©Ÿæœƒ';
                } else if (data.type === 'destiny') {
                    tile.classList.add("is-destiny");
                    tile.innerHTML = '<i class="fas fa-exclamation-circle" style="font-size:3vmin;margin-bottom:5px;"></i>å‘½é‹';
                }

                const coords = gridCoordinates[index];
                tile.style.gridRow = coords.r;
                tile.style.gridColumn = coords.c;
                container.appendChild(tile);
            });
        }

        renderPlayers() {
            document.querySelectorAll('.player-token').forEach(el => el.remove());
            document.querySelectorAll('.tile').forEach(tile => tile.classList.remove('has-p1', 'has-p2'));

            this.players.forEach(p => {
                const tile = document.getElementById(`tile-${p.pos}`);
                tile.classList.add(p.id === 1 ? 'has-p1' : 'has-p2');
                const token = document.createElement('div');
                token.className = `player-token ${p.colorClass}`;
                token.innerHTML = p.icon;
                tile.appendChild(token);
            });
        }

        renderProperties() {
            mapData.forEach((data, index) => {
                if (data.type === 'prop') {
                    const tile = document.getElementById(`tile-${index}`);
                    const houseContainer = document.getElementById(`houses-${index}`);
                    
                    tile.classList.remove('owned-p1', 'owned-p2');
                    if (data.owner === 1) tile.classList.add('owned-p1');
                    if (data.owner === 2) tile.classList.add('owned-p2');

                    houseContainer.innerHTML = '';
                    for (let i = 0; i < data.level; i++) {
                        const house = document.createElement('i');
                        house.className = 'fas fa-home house-icon';
                        houseContainer.appendChild(house);
                    }
                }
            });
        }

        updateInfoPanel() {
            document.getElementById('p1-money').innerText = this.players[0].money.toLocaleString();
            document.getElementById('p2-money').innerText = this.players[1].money.toLocaleString();
            document.getElementById('p1-skip').style.display = this.players[0].skipTurn > 0 ? 'flex' : 'none';
            document.getElementById('p2-skip').style.display = this.players[1].skipTurn > 0 ? 'flex' : 'none';
            
            document.getElementById('p1-card').classList.toggle('active', this.currentPlayerIndex === 0);
            document.getElementById('p2-card').classList.toggle('active', this.currentPlayerIndex === 1);
        }

        async turn() {
            if (this.isMoving || this.isGameOver) return;
            this.isMoving = true;
            this.rollBtn.disabled = true;
            
            const player = this.players[this.currentPlayerIndex];

            // æª¢æŸ¥æš«åœ
            if (player.skipTurn > 0) {
                player.skipTurn--;
                this.statusText.innerText = `${player.name} æš«åœä¸€æ¬¡\n(å‰©é¤˜ ${player.skipTurn} æ¬¡)`;
                this.updateInfoPanel();
                await new Promise(r => setTimeout(r, 1500));
                this.switchTurn();
                return;
            }

            this.statusText.innerText = `${player.name} æ“²éª°ä¸­...`;
            this.diceWrapper.style.display = 'block';
            this.dice.style.transition = 'none';
            this.dice.style.transform = 'rotateX(0deg) rotateY(0deg)';
            void this.dice.offsetWidth; // è§¸ç™¼é‡ç¹ª

            const roll = Math.floor(Math.random() * 6) + 1;
            
            // ä¿®æ­£å¾Œçš„ 3D æ—‹è½‰è§’åº¦ï¼Œç¢ºä¿è¦–è¦ºèˆ‡æ•¸å€¼ä¸€è‡´
            // 1:Front, 2:Back, 3:Right(-90y), 4:Left(90y), 5:Top(-90x), 6:Bottom(90x)
            // æ ¹æ“š CSS transform å®šç¾©æ ¡æ­£:
            const rotations = {
                1: { x: 720, y: 720 },
                2: { x: 720, y: 900 },
                3: { x: 720, y: 630 }, 
                4: { x: 720, y: 810 }, 
                5: { x: 630, y: 720 }, 
                6: { x: 810, y: 720 }  
            };
            const target = rotations[roll];
            
            // åŠ å…¥äº›å¾®éš¨æ©Ÿåç§»è®“å‹•ç•«æ›´è‡ªç„¶
            const rx = target.x + (Math.random() - 0.5) * 5;
            const ry = target.y + (Math.random() - 0.5) * 5;

            this.dice.style.transition = 'transform 1.5s cubic-bezier(0.1, 0.9, 0.2, 1)';
            this.dice.style.transform = `rotateX(${rx}deg) rotateY(${ry}deg)`;

            await new Promise(r => setTimeout(r, 1500));
            this.statusText.innerText = `æ“²å‡ºäº† ${roll} é»`;
            await new Promise(r => setTimeout(r, 1000));
            this.diceWrapper.style.display = 'none';

            // ç§»å‹•
            await this.movePlayerStepByStep(roll);

            // åˆ¤æ–·åœ°é»äº‹ä»¶
            const locData = mapData[player.pos];
            if (locData.type === 'chance') {
                const card = await this.triggerCard("chance");
                await this.processCardEffect(card);
            } else if (locData.type === 'destiny') {
                const card = await this.triggerCard("destiny");
                await this.processCardEffect(card);
            } else if (locData.type === 'prop') {
                await this.handleProperty(locData, player);
            }

            if (!this.isGameOver) this.switchTurn();
        }

        async movePlayerStepByStep(steps) {
            const player = this.players[this.currentPlayerIndex];
            const direction = steps > 0 ? 1 : -1;
            const count = Math.abs(steps);

            for (let i = 0; i < count; i++) {
                let nextPos = (player.pos + direction) % mapData.length;
                if (nextPos < 0) nextPos += mapData.length;
                player.pos = nextPos;
                this.renderPlayers();
                // æ’­æ”¾æ•ˆæœéŸ³? é€™è£¡ç”¨ delay æ¨¡æ“¬
                await new Promise(r => setTimeout(r, 300));
            }
            this.statusText.innerText = `æŠµé”ï¼š${mapData[player.pos].name}`;
            await new Promise(r => setTimeout(r, 500));
        }

        async handleProperty(prop, player) {
            // 1. ç„¡äººæ“æœ‰çš„åœ° -> è©¢å•è³¼è²·
            if (prop.owner === null) {
                const wantBuy = await this.askQuestion("è³¼è²·åœ°ç”¢", `${player.name}ï¼Œè¦è³¼è²· ${prop.name} å—ï¼Ÿ\n\nåƒ¹æ ¼: $${prop.price}\n(ç›®å‰ç¾é‡‘: $${player.money})`);
                if (wantBuy) {
                    if (player.money >= prop.price) {
                        player.money -= prop.price;
                        prop.owner = player.id;
                        this.statusText.innerText = `è³¼è²·æˆåŠŸï¼\n${player.name} ç²å¾—äº† ${prop.name}`;
                        this.renderProperties();
                        this.updateInfoPanel();
                        await new Promise(r => setTimeout(r, 1000));
                    } else {
                        this.statusText.innerText = `ç¾é‡‘ä¸è¶³ï¼Œç„¡æ³•è³¼è²·ï¼`;
                        await new Promise(r => setTimeout(r, 1500));
                    }
                }
            } 
            // 2. å°æ‰‹çš„åœ° -> ä»˜éè·¯è²»
            else if (prop.owner !== player.id) {
                const rent = prop.rent * (1 + prop.level);
                this.statusText.innerText = `è¸©åˆ°ç©å®¶ ${prop.owner} çš„åœ°ç›¤ï¼\næ”¯ä»˜éè·¯è²» $${rent}`;
                await new Promise(r => setTimeout(r, 1500));
                
                player.money -= rent;
                this.players[prop.owner - 1].money += rent;
                this.updateInfoPanel();
                
                if (this.checkBankruptcy(player)) return;
            } 
            // 3. è‡ªå·±çš„åœ° -> è©¢å•è“‹æˆ¿
            else {
                if (prop.level < 3) {
                    const buildCost = Math.floor(prop.price * 0.5);
                    const wantBuild = await this.askQuestion("å‡ç´šåœ°ç”¢", `æ­¡è¿å›å®¶ï¼è¦ç‚º ${prop.name} åŠ è“‹æˆ¿å±‹å—ï¼Ÿ\n\nè²»ç”¨: $${buildCost}`);
                    if (wantBuild) {
                        if (player.money >= buildCost) {
                            player.money -= buildCost;
                            prop.level++;
                            this.statusText.innerText = `æ“´å»ºæˆåŠŸï¼\n${prop.name} å‡ç´šç‚º ${prop.level} ç´šæˆ¿å±‹`;
                            this.renderProperties();
                            this.updateInfoPanel();
                            await new Promise(r => setTimeout(r, 1000));
                        } else {
                            this.statusText.innerText = `ç¾é‡‘ä¸è¶³ï¼`;
                            await new Promise(r => setTimeout(r, 1500));
                        }
                    }
                } else {
                    this.statusText.innerText = `${prop.name} å·²é”æœ€é«˜ç­‰ç´šï¼`;
                    await new Promise(r => setTimeout(r, 1000));
                }
            }
        }

        async processCardEffect(card) {
            const player = this.players[this.currentPlayerIndex];
            
            if (card.type === 'money') {
                player.money += card.val;
                this.statusText.innerText = card.val > 0 ? `ç²å¾—è³‡é‡‘ $${card.val}` : `æ”¯ä»˜è³‡é‡‘ $${Math.abs(card.val)}`;
            } else if (card.type === 'move') {
                this.statusText.innerText = `ç§»å‹•ä¸­...`;
                await new Promise(r => setTimeout(r, 500));
                await this.movePlayerStepByStep(card.val);
            } else if (card.type === 'goto') {
                this.statusText.innerText = `ç¬é–“ç§»å‹•ï¼`;
                await new Promise(r => setTimeout(r, 800));
                player.pos = card.target;
                this.renderPlayers();
            } else if (card.type === 'stop') {
                player.skipTurn = card.val;
                this.statusText.innerText = `ä¸‹å›åˆæš«åœï¼`;
            }
            
            this.updateInfoPanel();
            this.checkBankruptcy(player);
            await new Promise(r => setTimeout(r, 1000));
        }

        checkBankruptcy(player) {
            if (player.money < 0) {
                this.isGameOver = true;
                const winner = this.players.find(p => p.id !== player.id);
                
                this.overlay.classList.add('active');
                this.modalBox.classList.add('active-mode');
                this.cardContainer.classList.remove('active-mode');
                
                this.modalTitle.innerText = "éŠæˆ²çµæŸ";
                this.modalTitle.style.color = "#d32f2f";
                this.modalText.innerHTML = `<span style="font-size:1.2em">${player.name} ç ´ç”¢äº†ï¼</span><br><br>ğŸ† ç²å‹è€…ï¼š<span style="color:${winner.id===1?'#d32f2f':'#2e7d32'};font-weight:bold">${winner.name}</span>`;
                this.modalYes.style.display = 'none';
                this.modalNo.style.display = 'none';
                
                // é‡æ–°é–‹å§‹æŒ‰éˆ•
                const restartBtn = document.createElement('button');
                restartBtn.className = 'modal-btn';
                restartBtn.style.backgroundColor = '#4caf50';
                restartBtn.innerText = "é‡æ–°é–‹å§‹";
                restartBtn.onclick = () => location.reload();
                
                // æ¸…é™¤èˆŠæŒ‰éˆ•ä¸¦æ·»åŠ æ–°æŒ‰éˆ•
                const btnGroup = this.modalBox.querySelector('.btn-group');
                btnGroup.innerHTML = '';
                btnGroup.appendChild(restartBtn);
                
                return true;
            }
            return false;
        }

        switchTurn() {
            this.currentPlayerIndex = this.currentPlayerIndex === 0 ? 1 : 0;
            const nextPlayer = this.players[this.currentPlayerIndex];
            this.statusText.innerText = `è¼ªåˆ° ${nextPlayer.name}`;
            this.statusText.style.color = nextPlayer.id === 1 ? '#d32f2f' : '#2e7d32';
            this.rollBtn.disabled = false;
            this.isMoving = false;
        }

        // é€šç”¨è©¢å•å‡½æ•¸
        askQuestion(title, text) {
            return new Promise((resolve) => {
                this.overlay.classList.add('active');
                this.modalBox.classList.add('active-mode');
                this.cardContainer.classList.remove('active-mode');
                
                this.modalTitle.innerText = title;
                this.modalText.innerText = text;

                // é‡ç½®æŒ‰éˆ•äº‹ä»¶
                const newYes = this.modalYes.cloneNode(true);
                const newNo = this.modalNo.cloneNode(true);
                this.modalYes.parentNode.replaceChild(newYes, this.modalYes);
                this.modalNo.parentNode.replaceChild(newNo, this.modalNo);
                this.modalYes = newYes;
                this.modalNo = newNo;
                
                this.modalYes.style.display = 'inline-block';
                this.modalNo.style.display = 'inline-block';

                this.modalYes.onclick = () => { this.closeOverlay(); resolve(true); };
                this.modalNo.onclick = () => { this.closeOverlay(); resolve(false); };
            });
        }

        // è§¸ç™¼å¡ç‰‡
        triggerCard(type) {
            return new Promise((resolve) => {
                this.overlay.classList.add('active');
                this.cardContainer.classList.add('active-mode');
                this.modalBox.classList.remove('active-mode');
                this.cardContainer.classList.remove('flipped'); // é‡ç½®ç¿»é¢

                const list = type === "chance" ? chanceCards : destinyCards;
                this.currentCardData = list[Math.floor(Math.random() * list.length)];
                
                if (type === "chance") {
                    this.cardFront.className = "card-front chance-bg";
                    this.cardFront.innerHTML = '<i class="fas fa-question"></i><h2>æ©Ÿæœƒ</h2><p style="margin-top:10px;font-size:0.8em">é»æ“Šç¿»ç‰Œ</p>';
                    document.getElementById('card-title').innerText = "æ©Ÿæœƒå¡";
                    document.getElementById('card-title').style.color = "#7b1fa2";
                } else {
                    this.cardFront.className = "card-front destiny-bg";
                    this.cardFront.innerHTML = '<i class="fas fa-exclamation"></i><h2>å‘½é‹</h2><p style="margin-top:10px;font-size:0.8em">é»æ“Šç¿»ç‰Œ</p>';
                    document.getElementById('card-title').innerText = "å‘½é‹å¡";
                    document.getElementById('card-title').style.color = "#e64a19";
                }

                // è¨­å®šå¡ç‰‡å…§å®¹
                document.getElementById('card-icon-area').innerHTML = `<i class="fas ${this.currentCardData.icon}"></i>`;
                document.getElementById('card-desc').innerText = this.currentCardData.text;
                
                this.currentCardResolve = resolve;
            });
        }

        closeCard() {
            this.closeOverlay();
            if (this.currentCardResolve) {
                this.currentCardResolve(this.currentCardData);
                this.currentCardResolve = null;
            }
        }

        closeOverlay() {
            this.overlay.classList.remove('active');
            this.cardContainer.classList.remove('active-mode');
            this.modalBox.classList.remove('active-mode');
        }
    }

    const game = new Game();
</script>

</body>
</html>
